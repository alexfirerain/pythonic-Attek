from dataclasses import dataclass
from typing import List

from astrowidja.utils.harmonix import Harmonics
from astrowidja.utils.mechanics import second_format
from astrowidja.model.precision_class import PrecisionClass


@dataclass(frozen=True)
class Aspect:
    """
    Некоторая установленная для реальной дуги гармоническая кратность.
    Аспект характеризуется математическим определением резонанса
    (основное гармоническое число и множитель повторения кратности)
    и степенью точности (добротности) резонанса, определяемой как близость
    реального небесного расстояния к дуге точного аспекта.
    """

    numeric: int
    """
    Гармоника, в которой аспект предстаёт соединением.
    Т.е. число, на которое делится Круг, чтобы получить
    дугу единичного резонанса для данной гармоники.
    Иначе говоря, резонансное число аспекта, или номер гармоники.
    Например, дугам в 45° и 135° соответствует резонансное число 8.
    """

    multiplicity: int
    """
    Множитель дальности, или повторитель кратности. Т.е. то число, на которое
    нужно умножить дугу единичного резонанса этой гармоники, чтоб получить
    дугу чистого неединичного аспекта.
    Например, дуга в 45° имеет множитель 1, а дуга в 135° — множитель 3.
    Резонансное число не должно быть кратно множителю,
    например вместо аспекта 2/8 берётся аспект 1/4.
    """

    clearance: float
    """
    Разность фактической дуги между астрами с дугой чистого аспекта,
    экзакта, вычисляемой как `(360° / гармоника) * множитель`.
    Т.е. эффективный орбис аспекта.
    """

    strength: float
    """
    Эффективный орбис аспекта, выраженный в %-ах, где 100% означает полное
    совпадение реальной дуги с математическим аспектом (экзакт, эффективный орбис 0°),
    а 0% означает совпадение эффективного орбиса с предельным для данной гармоники.
    Иначе говоря, точность аспекта, выраженная в %-ах.
    """

    depth: int
    """
    Глубина аспекта, т.е. его точность, выраженная через количество
    бóльших кратных гармоник, через которые он проходит, сохраняется.
    Глубина равна 0, если аспект отсутствует;
    равна 1, если аспект присутствует только в этой гармонике;
    равна n, если соединение присутствует в гармониках кратностью до n от данной.
    """

    precision_class: PrecisionClass
    """ Класс точности аспекта, определяющий его силу и категорию. """

    def __init__(self, numeric: int, clearance: float, from_arc: float, orb: float):
        """
        Конструктор аспекта, т.е. одного из резонансов в дуге.

        :param numeric: гармоника, т.е. кратность дуги Кругу.
        :param clearance: эффективный орбис в карте гармоники.
        :param from_arc: реальная дуга, в которой распознан этот резонанс.
        :param orb: первичный орб для соединений, используемый при определении резонансов.
                    При этом если используется сокращение орба для синастрий (по умолчанию),
                    сюда передаётся уже сокращённое значение.
        """
        object.__setattr__(self, 'numeric', numeric)
        object.__setattr__(self, 'clearance', clearance)

        multiplicity = Harmonics.find_multiplier(numeric, from_arc, orb)
        strength = self._calculate_strength(orb, clearance)
        depth = int(clearance) if clearance <= orb else int(orb // clearance)

        object.__setattr__(self, 'multiplicity', multiplicity)
        object.__setattr__(self, 'strength', strength)
        object.__setattr__(self, 'depth', depth)

        if depth <= 0:
            precision_class = PrecisionClass.NONE
        elif depth == 1:
            precision_class = PrecisionClass.APPROXIMATE
        elif depth == 2:
            precision_class = PrecisionClass.CONFIDENT
        elif depth <= 5:
            precision_class = PrecisionClass.DEEP
        elif depth <= 12:
            precision_class = PrecisionClass.ACCURATE
        elif depth <= 24:
            precision_class = PrecisionClass.PRECISE
        else:
            precision_class = PrecisionClass.EXACT

        object.__setattr__(self, 'precision_class', precision_class)

    @staticmethod
    def _calculate_strength(orb: float, clearance: float) -> float:
        """Рассчитывает силу аспекта как процент от максимально допустимого зазора."""
        if orb <= 0:
            return 0.0
        return max(0.0, min(100.0, (1 - abs(clearance) / orb) * 100))

    def get_multipliers(self) -> List[int]:
        """
        Выдаёт список простых множителей, в произведении дающих
        число резонанса данного аспекта.

        :return: список множителей гармоники, каждый из которых является простым числом.
        """
        return Harmonics.multipliers_explicate(self.numeric)

    def has_multiplier(self, base_harmonic: int) -> bool:
        """
        Сообщает, кратно ли резонансное число этого аспекта данному числу.
        То есть присутствует ли указанное число среди множителей, дающих
        резонансное число аспекта.

        :param base_harmonic: проверяемый на кратность множитель.
        :return: True, если резонансное число аспекта кратно данному.
        """
        return base_harmonic in self.get_multipliers()

    def get_strength_level(self) -> str:
        """
        Выводит строковую характеристику, насколько точен резонанс.
        Та же градация, что для рейтинга в виде звёздочек:
        - <= 0% - отсутствует в данной гармонике
        - приблизительный < 50% - присутствует только в данной гармонике
        - уверенный 50-66% - присутствует в данной и в следующей х2
        - глубокий 67-83% - сохраняется ещё в гармониках х3, х4 и х5
        - точный 84-92% - сохраняется до гармоник х12
        - глубоко точный 93-96% - сохраняется до х24 гармоник
        - крайне точный > 96 % - присутствует в нескольких десятках кратных гармоник

        :return: строковое представление ранга точности.
        """
        return self.precision_class.get_depth_desc()

    def strength_rating(self) -> str:
        """
        Рейтинг силы, выраженный строкой со звёздочками,
        та же градация, что для строковой характеристики:
        _        <= 0% - отсутствует в данной гармонике
        ★        < 50% - присутствует только в данной гармонике
        ★★       50-66% - присутствует в данной и в следующей х2
        ★★★     67-83% - сохраняется ещё в гармониках х3, х4 и х5
        ★★★★    84-92% - сохраняется до гармоник х12
        ★★★★★   93-96% - сохраняется до х24 гармоник
        ✰✰✰✰✰   > 96 % - присутствует в нескольких десятках кратных гармоник

        :return: звездообразный код рейтинга силы согласно соответствию.
        """
        return self.precision_class.get_rating()

    def has_resonance(self, harmonic: int) -> bool:
        """
        Сообщает, присутствует ли данный аспект (т.е. связь по этому
        резонансному числу) в карте указанной гармоники.
        Например, мы имеем аспект трин (numeric = 3) — он сохраняется в секстиле (6-й гармонике),
        если глубина аспекта >= 2, а если сила аспекта < 50% (т.е. зазор больше половины орбиса),
        то не сохраняется. В полусекстиле (12-й гармонике) он же сохраняется при глубине >= 4,
        а если сила аспекта < 25% (т.е. зазор больше четверти, т.е., для трина при первичном
        орбисе 12°, больше 1°), то нет.

        :param harmonic: номер гармоники, относительно которой проверяется актуальность аспекта.
        :return: True, если резонансное число аспекта кратно запрашиваемой гармонике,
                 и он достаточно силён, чтобы проявиться в ней. И обратное в ином случае.
        """
        if harmonic <= 0:
            raise ValueError("Номер гармоники должен быть положительным.")
        return harmonic % self.numeric == 0 and harmonic // self.numeric <= self.depth

    def __str__(self) -> str:
        mult_part = f"(x{self.multiplicity}) " if self.multiplicity > 1 else ""
        return (f"Резонанс {self.numeric} {mult_part}- {self.get_strength_level()} "
                f"как {self.depth} ({self.strength:.2f}%%, {second_format(self.clearance, True)})")